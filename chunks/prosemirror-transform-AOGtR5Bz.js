import{a as le}from"./@mozilla-DKYphB57.js";import{d as f}from"./prosemirror-model-BL7fTrkh.js";const K=65535,Q=Math.pow(2,16);function oe(s,e){return s+e*Q}function G(s){return s&K}function ae(s){return(s-(s&K))/Q}const U=1,V=2,J=4,X=8;class A{constructor(e,t,r){this.pos=e,this.delInfo=t,this.recover=r}get deleted(){return(this.delInfo&X)>0}get deletedBefore(){return(this.delInfo&(U|J))>0}get deletedAfter(){return(this.delInfo&(V|J))>0}get deletedAcross(){return(this.delInfo&J)>0}}class k{constructor(e,t=!1){if(this.ranges=e,this.inverted=t,!e.length&&k.empty)return k.empty}recover(e){let t=0,r=G(e);if(!this.inverted)for(let n=0;n<r;n++)t+=this.ranges[n*3+2]-this.ranges[n*3+1];return this.ranges[r*3]+t+ae(e)}mapResult(e,t=1){return this._map(e,t,!1)}map(e,t=1){return this._map(e,t,!0)}_map(e,t,r){let n=0,i=this.inverted?2:1,l=this.inverted?1:2;for(let o=0;o<this.ranges.length;o+=3){let a=this.ranges[o]-(this.inverted?n:0);if(a>e)break;let h=this.ranges[o+i],p=this.ranges[o+l],d=a+h;if(e<=d){let c=h?e==a?-1:e==d?1:t:t,u=a+n+(c<0?0:p);if(r)return u;let m=e==(t<0?a:d)?null:oe(o/3,e-a),g=e==a?V:e==d?U:J;return(t<0?e!=a:e!=d)&&(g|=X),new A(u,g,m)}n+=p-h}return r?e+n:new A(e+n,0,null)}touches(e,t){let r=0,n=G(t),i=this.inverted?2:1,l=this.inverted?1:2;for(let o=0;o<this.ranges.length;o+=3){let a=this.ranges[o]-(this.inverted?r:0);if(a>e)break;let h=this.ranges[o+i],p=a+h;if(e<=p&&o==n*3)return!0;r+=this.ranges[o+l]-h}return!1}forEach(e){let t=this.inverted?2:1,r=this.inverted?1:2;for(let n=0,i=0;n<this.ranges.length;n+=3){let l=this.ranges[n],o=l-(this.inverted?i:0),a=l+(this.inverted?0:i),h=this.ranges[n+t],p=this.ranges[n+r];e(o,o+h,a,a+p),i+=p-h}}invert(){return new k(this.ranges,!this.inverted)}toString(){return(this.inverted?"-":"")+JSON.stringify(this.ranges)}static offset(e){return e==0?k.empty:new k(e<0?[0,-e,0]:[0,0,e])}}k.empty=new k([]);class E{constructor(e=[],t,r=0,n=e.length){this.maps=e,this.mirror=t,this.from=r,this.to=n}slice(e=0,t=this.maps.length){return new E(this.maps,this.mirror,e,t)}copy(){return new E(this.maps.slice(),this.mirror&&this.mirror.slice(),this.from,this.to)}appendMap(e,t){this.to=this.maps.push(e),t!=null&&this.setMirror(this.maps.length-1,t)}appendMapping(e){for(let t=0,r=this.maps.length;t<e.maps.length;t++){let n=e.getMirror(t);this.appendMap(e.maps[t],n!=null&&n<t?r+n:void 0)}}getMirror(e){if(this.mirror){for(let t=0;t<this.mirror.length;t++)if(this.mirror[t]==e)return this.mirror[t+(t%2?-1:1)]}}setMirror(e,t){this.mirror||(this.mirror=[]),this.mirror.push(e,t)}appendMappingInverted(e){for(let t=e.maps.length-1,r=this.maps.length+e.maps.length;t>=0;t--){let n=e.getMirror(t);this.appendMap(e.maps[t].invert(),n!=null&&n>t?r-n-1:void 0)}}invert(){let e=new E;return e.appendMappingInverted(this),e}map(e,t=1){if(this.mirror)return this._map(e,t,!0);for(let r=this.from;r<this.to;r++)e=this.maps[r].map(e,t);return e}mapResult(e,t=1){return this._map(e,t,!1)}_map(e,t,r){let n=0;for(let i=this.from;i<this.to;i++){let l=this.maps[i],o=l.mapResult(e,t);if(o.recover!=null){let a=this.getMirror(i);if(a!=null&&a>i&&a<this.to){i=a,e=this.maps[a].recover(o.recover);continue}}n|=o.delInfo,e=o.pos}return r?e:new A(e,n,null)}}const B=Object.create(null);class y{getMap(){return k.empty}merge(e){return null}static fromJSON(e,t){if(!t||!t.stepType)throw new RangeError("Invalid input for Step.fromJSON");let r=B[t.stepType];if(!r)throw new RangeError(`No step type ${t.stepType} defined`);return r.fromJSON(e,t)}static jsonID(e,t){if(e in B)throw new RangeError("Duplicate use of step JSON ID "+e);return B[e]=t,t.prototype.jsonID=e,t}}class w{constructor(e,t){this.doc=e,this.failed=t}static ok(e){return new w(e,null)}static fail(e){return new w(null,e)}static fromReplace(e,t,r,n){try{return w.ok(e.replace(t,r,n))}catch(i){if(i instanceof f.ReplaceError)return w.fail(i.message);throw i}}}function $(s,e,t){let r=[];for(let n=0;n<s.childCount;n++){let i=s.child(n);i.content.size&&(i=i.copy($(i.content,e,i))),i.isInline&&(i=e(i,t,n)),r.push(i)}return f.Fragment.fromArray(r)}class M extends y{constructor(e,t,r){super(),this.from=e,this.to=t,this.mark=r}apply(e){let t=e.slice(this.from,this.to),r=e.resolve(this.from),n=r.node(r.sharedDepth(this.to)),i=new f.Slice($(t.content,(l,o)=>!l.isAtom||!o.type.allowsMarkType(this.mark.type)?l:l.mark(this.mark.addToSet(l.marks)),n),t.openStart,t.openEnd);return w.fromReplace(e,this.from,this.to,i)}invert(){return new x(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deleted&&r.deleted||t.pos>=r.pos?null:new M(t.pos,r.pos,this.mark)}merge(e){return e instanceof M&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new M(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"addMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for AddMarkStep.fromJSON");return new M(t.from,t.to,e.markFromJSON(t.mark))}}y.jsonID("addMark",M);class x extends y{constructor(e,t,r){super(),this.from=e,this.to=t,this.mark=r}apply(e){let t=e.slice(this.from,this.to),r=new f.Slice($(t.content,n=>n.mark(this.mark.removeFromSet(n.marks)),e),t.openStart,t.openEnd);return w.fromReplace(e,this.from,this.to,r)}invert(){return new M(this.from,this.to,this.mark)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deleted&&r.deleted||t.pos>=r.pos?null:new x(t.pos,r.pos,this.mark)}merge(e){return e instanceof x&&e.mark.eq(this.mark)&&this.from<=e.to&&this.to>=e.from?new x(Math.min(this.from,e.from),Math.max(this.to,e.to),this.mark):null}toJSON(){return{stepType:"removeMark",mark:this.mark.toJSON(),from:this.from,to:this.to}}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for RemoveMarkStep.fromJSON");return new x(t.from,t.to,e.markFromJSON(t.mark))}}y.jsonID("removeMark",x);class C extends y{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return w.fail("No node at mark step's position");let r=t.type.create(t.attrs,null,this.mark.addToSet(t.marks));return w.fromReplace(e,this.pos,this.pos+1,new f.Slice(f.Fragment.from(r),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);if(t){let r=this.mark.addToSet(t.marks);if(r.length==t.marks.length){for(let n=0;n<t.marks.length;n++)if(!t.marks[n].isInSet(r))return new C(this.pos,t.marks[n]);return new C(this.pos,this.mark)}}return new I(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new C(t.pos,this.mark)}toJSON(){return{stepType:"addNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for AddNodeMarkStep.fromJSON");return new C(t.pos,e.markFromJSON(t.mark))}}y.jsonID("addNodeMark",C);class I extends y{constructor(e,t){super(),this.pos=e,this.mark=t}apply(e){let t=e.nodeAt(this.pos);if(!t)return w.fail("No node at mark step's position");let r=t.type.create(t.attrs,null,this.mark.removeFromSet(t.marks));return w.fromReplace(e,this.pos,this.pos+1,new f.Slice(f.Fragment.from(r),0,t.isLeaf?0:1))}invert(e){let t=e.nodeAt(this.pos);return!t||!this.mark.isInSet(t.marks)?this:new C(this.pos,this.mark)}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new I(t.pos,this.mark)}toJSON(){return{stepType:"removeNodeMark",pos:this.pos,mark:this.mark.toJSON()}}static fromJSON(e,t){if(typeof t.pos!="number")throw new RangeError("Invalid input for RemoveNodeMarkStep.fromJSON");return new I(t.pos,e.markFromJSON(t.mark))}}y.jsonID("removeNodeMark",I);class S extends y{constructor(e,t,r,n=!1){super(),this.from=e,this.to=t,this.slice=r,this.structure=n}apply(e){return this.structure&&L(e,this.from,this.to)?w.fail("Structure replace would overwrite content"):w.fromReplace(e,this.from,this.to,this.slice)}getMap(){return new k([this.from,this.to-this.from,this.slice.size])}invert(e){return new S(this.from,this.from+this.slice.size,e.slice(this.from,this.to))}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1);return t.deletedAcross&&r.deletedAcross?null:new S(t.pos,Math.max(t.pos,r.pos),this.slice)}merge(e){if(!(e instanceof S)||e.structure||this.structure)return null;if(this.from+this.slice.size==e.from&&!this.slice.openEnd&&!e.slice.openStart){let t=this.slice.size+e.slice.size==0?f.Slice.empty:new f.Slice(this.slice.content.append(e.slice.content),this.slice.openStart,e.slice.openEnd);return new S(this.from,this.to+(e.to-e.from),t,this.structure)}else if(e.to==this.from&&!this.slice.openStart&&!e.slice.openEnd){let t=this.slice.size+e.slice.size==0?f.Slice.empty:new f.Slice(e.slice.content.append(this.slice.content),e.slice.openStart,this.slice.openEnd);return new S(e.from,this.to,t,this.structure)}else return null}toJSON(){let e={stepType:"replace",from:this.from,to:this.to};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number")throw new RangeError("Invalid input for ReplaceStep.fromJSON");return new S(t.from,t.to,f.Slice.fromJSON(e,t.slice),!!t.structure)}}y.jsonID("replace",S);class b extends y{constructor(e,t,r,n,i,l,o=!1){super(),this.from=e,this.to=t,this.gapFrom=r,this.gapTo=n,this.slice=i,this.insert=l,this.structure=o}apply(e){if(this.structure&&(L(e,this.from,this.gapFrom)||L(e,this.gapTo,this.to)))return w.fail("Structure gap-replace would overwrite content");let t=e.slice(this.gapFrom,this.gapTo);if(t.openStart||t.openEnd)return w.fail("Gap is not a flat range");let r=this.slice.insertAt(this.insert,t.content);return r?w.fromReplace(e,this.from,this.to,r):w.fail("Content does not fit in gap")}getMap(){return new k([this.from,this.gapFrom-this.from,this.insert,this.gapTo,this.to-this.gapTo,this.slice.size-this.insert])}invert(e){let t=this.gapTo-this.gapFrom;return new b(this.from,this.from+this.slice.size+t,this.from+this.insert,this.from+this.insert+t,e.slice(this.from,this.to).removeBetween(this.gapFrom-this.from,this.gapTo-this.from),this.gapFrom-this.from,this.structure)}map(e){let t=e.mapResult(this.from,1),r=e.mapResult(this.to,-1),n=this.from==this.gapFrom?t.pos:e.map(this.gapFrom,-1),i=this.to==this.gapTo?r.pos:e.map(this.gapTo,1);return t.deletedAcross&&r.deletedAcross||n<t.pos||i>r.pos?null:new b(t.pos,r.pos,n,i,this.slice,this.insert,this.structure)}toJSON(){let e={stepType:"replaceAround",from:this.from,to:this.to,gapFrom:this.gapFrom,gapTo:this.gapTo,insert:this.insert};return this.slice.size&&(e.slice=this.slice.toJSON()),this.structure&&(e.structure=!0),e}static fromJSON(e,t){if(typeof t.from!="number"||typeof t.to!="number"||typeof t.gapFrom!="number"||typeof t.gapTo!="number"||typeof t.insert!="number")throw new RangeError("Invalid input for ReplaceAroundStep.fromJSON");return new b(t.from,t.to,t.gapFrom,t.gapTo,f.Slice.fromJSON(e,t.slice),t.insert,!!t.structure)}}y.jsonID("replaceAround",b);function L(s,e,t){let r=s.resolve(e),n=t-e,i=r.depth;for(;n>0&&i>0&&r.indexAfter(i)==r.node(i).childCount;)i--,n--;if(n>0){let l=r.node(i).maybeChild(r.indexAfter(i));for(;n>0;){if(!l||l.isLeaf)return!0;l=l.firstChild,n--}}return!1}function he(s,e,t,r){let n=[],i=[],l,o;s.doc.nodesBetween(e,t,(a,h,p)=>{if(!a.isInline)return;let d=a.marks;if(!r.isInSet(d)&&p.type.allowsMarkType(r.type)){let c=Math.max(h,e),u=Math.min(h+a.nodeSize,t),m=r.addToSet(d);for(let g=0;g<d.length;g++)d[g].isInSet(m)||(l&&l.to==c&&l.mark.eq(d[g])?l.to=u:n.push(l=new x(c,u,d[g])));o&&o.to==c?o.to=u:i.push(o=new M(c,u,r))}}),n.forEach(a=>s.step(a)),i.forEach(a=>s.step(a))}function pe(s,e,t,r){let n=[],i=0;s.doc.nodesBetween(e,t,(l,o)=>{if(!l.isInline)return;i++;let a=null;if(r instanceof f.MarkType){let h=l.marks,p;for(;p=r.isInSet(h);)(a||(a=[])).push(p),h=p.removeFromSet(h)}else r?r.isInSet(l.marks)&&(a=[r]):a=l.marks;if(a&&a.length){let h=Math.min(o+l.nodeSize,t);for(let p=0;p<a.length;p++){let d=a[p],c;for(let u=0;u<n.length;u++){let m=n[u];m.step==i-1&&d.eq(n[u].style)&&(c=m)}c?(c.to=h,c.step=i):n.push({style:d,from:Math.max(o,e),to:h,step:i})}}}),n.forEach(l=>s.step(new x(l.from,l.to,l.style)))}function q(s,e,t,r=t.contentMatch,n=!0){let i=s.doc.nodeAt(e),l=[],o=e+1;for(let a=0;a<i.childCount;a++){let h=i.child(a),p=o+h.nodeSize,d=r.matchType(h.type);if(!d)l.push(new S(o,p,f.Slice.empty));else{r=d;for(let c=0;c<h.marks.length;c++)t.allowsMarkType(h.marks[c].type)||s.step(new x(o,p,h.marks[c]));if(n&&h.isText&&t.whitespace!="pre"){let c,u=/\r?\n|\r/g,m;for(;c=u.exec(h.text);)m||(m=new f.Slice(f.Fragment.from(t.schema.text(" ",t.allowedMarks(h.marks))),0,0)),l.push(new S(o+c.index,o+c.index+c[0].length,m))}}o=p}if(!r.validEnd){let a=r.fillBefore(f.Fragment.empty,!0);s.replace(o,o,new f.Slice(a,0,0))}for(let a=l.length-1;a>=0;a--)s.step(l[a])}function fe(s,e,t){return(e==0||s.canReplace(e,s.childCount))&&(t==s.childCount||s.canReplace(0,t))}function ce(s){let t=s.parent.content.cutByIndex(s.startIndex,s.endIndex);for(let r=s.depth;;--r){let n=s.$from.node(r),i=s.$from.index(r),l=s.$to.indexAfter(r);if(r<s.depth&&n.canReplace(i,l,t))return r;if(r==0||n.type.spec.isolating||!fe(n,i,l))break}return null}function de(s,e,t){let{$from:r,$to:n,depth:i}=e,l=r.before(i+1),o=n.after(i+1),a=l,h=o,p=f.Fragment.empty,d=0;for(let m=i,g=!1;m>t;m--)g||r.index(m)>0?(g=!0,p=f.Fragment.from(r.node(m).copy(p)),d++):a--;let c=f.Fragment.empty,u=0;for(let m=i,g=!1;m>t;m--)g||n.after(m+1)<n.end(m)?(g=!0,c=f.Fragment.from(n.node(m).copy(c)),u++):h++;s.step(new b(a,h,l,o,new f.Slice(p.append(c),d,u),p.size-d,!0))}function ue(s,e,t=null,r=s){let n=me(s,e),i=n&&ge(r,e);return i?n.map(H).concat({type:e,attrs:t}).concat(i.map(H)):null}function H(s){return{type:s,attrs:null}}function me(s,e){let{parent:t,startIndex:r,endIndex:n}=s,i=t.contentMatchAt(r).findWrapping(e);if(!i)return null;let l=i.length?i[0]:e;return t.canReplaceWith(r,n,l)?i:null}function ge(s,e){let{parent:t,startIndex:r,endIndex:n}=s,i=t.child(r),l=e.contentMatch.findWrapping(i.type);if(!l)return null;let a=(l.length?l[l.length-1]:e).contentMatch;for(let h=r;a&&h<n;h++)a=a.matchType(t.child(h).type);return!a||!a.validEnd?null:l}function we(s,e,t){let r=f.Fragment.empty;for(let l=t.length-1;l>=0;l--){if(r.size){let o=t[l].type.contentMatch.matchFragment(r);if(!o||!o.validEnd)throw new RangeError("Wrapper type given to Transform.wrap does not form valid content of its parent wrapper")}r=f.Fragment.from(t[l].type.create(t[l].attrs,r))}let n=e.start,i=e.end;s.step(new b(n,i,n,i,new f.Slice(r,0,0),t.length,!0))}function ye(s,e,t,r,n){if(!r.isTextblock)throw new RangeError("Type given to setBlockType should be a textblock");let i=s.steps.length;s.doc.nodesBetween(e,t,(l,o)=>{let a=typeof n=="function"?n(l):n;if(l.isTextblock&&!l.hasMarkup(r,a)&&Se(s.doc,s.mapping.slice(i).map(o),r)){let h=null;if(r.schema.linebreakReplacement){let u=r.whitespace=="pre",m=!!r.contentMatch.matchType(r.schema.linebreakReplacement);u&&!m?h=!1:!u&&m&&(h=!0)}h===!1&&Z(s,l,o,i),q(s,s.mapping.slice(i).map(o,1),r,void 0,h===null);let p=s.mapping.slice(i),d=p.map(o,1),c=p.map(o+l.nodeSize,1);return s.step(new b(d,c,d+1,c-1,new f.Slice(f.Fragment.from(r.create(a,null,l.marks)),0,0),1,!0)),h===!0&&Y(s,l,o,i),!1}})}function Y(s,e,t,r){e.forEach((n,i)=>{if(n.isText){let l,o=/\r?\n|\r/g;for(;l=o.exec(n.text);){let a=s.mapping.slice(r).map(t+1+i+l.index);s.replaceWith(a,a+1,e.type.schema.linebreakReplacement.create())}}})}function Z(s,e,t,r){e.forEach((n,i)=>{if(n.type==n.type.schema.linebreakReplacement){let l=s.mapping.slice(r).map(t+1+i);s.replaceWith(l,l+1,e.type.schema.text(`
`))}})}function Se(s,e,t){let r=s.resolve(e),n=r.index();return r.parent.canReplaceWith(n,n+1,t)}function ke(s,e,t,r,n){let i=s.doc.nodeAt(e);if(!i)throw new RangeError("No node at given position");t||(t=i.type);let l=t.create(r,null,n||i.marks);if(i.isLeaf)return s.replaceWith(e,e+i.nodeSize,l);if(!t.validContent(i.content))throw new RangeError("Invalid content for node type "+t.name);s.step(new b(e,e+i.nodeSize,e+1,e+i.nodeSize-1,new f.Slice(f.Fragment.from(l),0,0),1,!0))}function ve(s,e,t=1,r){let n=s.resolve(e),i=n.depth-t,l=r&&r[r.length-1]||n.parent;if(i<0||n.parent.type.spec.isolating||!n.parent.canReplace(n.index(),n.parent.childCount)||!l.type.validContent(n.parent.content.cutByIndex(n.index(),n.parent.childCount)))return!1;for(let h=n.depth-1,p=t-2;h>i;h--,p--){let d=n.node(h),c=n.index(h);if(d.type.spec.isolating)return!1;let u=d.content.cutByIndex(c,d.childCount),m=r&&r[p+1];m&&(u=u.replaceChild(0,m.type.create(m.attrs)));let g=r&&r[p]||d;if(!d.canReplace(c+1,d.childCount)||!g.type.validContent(u))return!1}let o=n.indexAfter(i),a=r&&r[0];return n.node(i).canReplaceWith(o,o,a?a.type:n.node(i+1).type)}function xe(s,e,t=1,r){let n=s.doc.resolve(e),i=f.Fragment.empty,l=f.Fragment.empty;for(let o=n.depth,a=n.depth-t,h=t-1;o>a;o--,h--){i=f.Fragment.from(n.node(o).copy(i));let p=r&&r[h];l=f.Fragment.from(p?p.type.create(p.attrs,l):n.node(o).copy(l))}s.step(new S(e,e,new f.Slice(i.append(l),t,t),!0))}function be(s,e){let t=s.resolve(e),r=t.index();return j(t.nodeBefore,t.nodeAfter)&&t.parent.canReplace(r,r+1)}function Me(s,e){e.content.size||s.type.compatibleContent(e.type);let t=s.contentMatchAt(s.childCount),{linebreakReplacement:r}=s.type.schema;for(let n=0;n<e.childCount;n++){let i=e.child(n),l=i.type==r?s.type.schema.nodes.text:i.type;if(t=t.matchType(l),!t||!s.type.allowsMarks(i.marks))return!1}return t.validEnd}function j(s,e){return!!(s&&e&&!s.isLeaf&&Me(s,e))}function Ce(s,e,t=-1){let r=s.resolve(e);for(let n=r.depth;;n--){let i,l,o=r.index(n);if(n==r.depth?(i=r.nodeBefore,l=r.nodeAfter):t>0?(i=r.node(n+1),o++,l=r.node(n).maybeChild(o)):(i=r.node(n).maybeChild(o-1),l=r.node(n+1)),i&&!i.isTextblock&&j(i,l)&&r.node(n).canReplace(o,o+1))return e;if(n==0)break;e=t<0?r.before(n):r.after(n)}}function Fe(s,e,t){let r=null,{linebreakReplacement:n}=s.doc.type.schema,i=s.doc.resolve(e-t),l=i.node().type;if(n&&l.inlineContent){let p=l.whitespace=="pre",d=!!l.contentMatch.matchType(n);p&&!d?r=!1:!p&&d&&(r=!0)}let o=s.steps.length;if(r===!1){let p=s.doc.resolve(e+t);Z(s,p.node(),p.before(),o)}l.inlineContent&&q(s,e+t-1,l,i.node().contentMatchAt(i.index()),r==null);let a=s.mapping.slice(o),h=a.map(e-t);if(s.step(new S(h,a.map(e+t,-1),f.Slice.empty,!0)),r===!0){let p=s.doc.resolve(h);Y(s,p.node(),p.before(),s.steps.length)}return s}function _(s,e,t){let r=s.resolve(e);if(r.parent.canReplaceWith(r.index(),r.index(),t))return e;if(r.parentOffset==0)for(let n=r.depth-1;n>=0;n--){let i=r.index(n);if(r.node(n).canReplaceWith(i,i,t))return r.before(n+1);if(i>0)return null}if(r.parentOffset==r.parent.content.size)for(let n=r.depth-1;n>=0;n--){let i=r.indexAfter(n);if(r.node(n).canReplaceWith(i,i,t))return r.after(n+1);if(i<r.node(n).childCount)return null}return null}function Ne(s,e,t){let r=s.resolve(e);if(!t.content.size)return e;let n=t.content;for(let i=0;i<t.openStart;i++)n=n.firstChild.content;for(let i=1;i<=(t.openStart==0&&t.size?2:1);i++)for(let l=r.depth;l>=0;l--){let o=l==r.depth?0:r.pos<=(r.start(l+1)+r.end(l+1))/2?-1:1,a=r.index(l)+(o>0?1:0),h=r.node(l),p=!1;if(i==1)p=h.canReplace(a,a,n);else{let d=h.contentMatchAt(a).findWrapping(n.firstChild.type);p=d&&h.canReplaceWith(a,a,d[0])}if(p)return o==0?r.pos:o<0?r.before(l+1):r.after(l+1)}return null}function ee(s,e,t=e,r=f.Slice.empty){if(e==t&&!r.size)return null;let n=s.resolve(e),i=s.resolve(t);return te(n,i,r)?new S(e,t,r):new Ie(n,i,r).fit()}function te(s,e,t){return!t.openStart&&!t.openEnd&&s.start()==e.start()&&s.parent.canReplace(s.index(),e.index(),t.content)}class Ie{constructor(e,t,r){this.$from=e,this.$to=t,this.unplaced=r,this.frontier=[],this.placed=f.Fragment.empty;for(let n=0;n<=e.depth;n++){let i=e.node(n);this.frontier.push({type:i.type,match:i.contentMatchAt(e.indexAfter(n))})}for(let n=e.depth;n>0;n--)this.placed=f.Fragment.from(e.node(n).copy(this.placed))}get depth(){return this.frontier.length-1}fit(){for(;this.unplaced.size;){let h=this.findFittable();h?this.placeNodes(h):this.openMore()||this.dropNode()}let e=this.mustMoveInline(),t=this.placed.size-this.depth-this.$from.depth,r=this.$from,n=this.close(e<0?this.$to:r.doc.resolve(e));if(!n)return null;let i=this.placed,l=r.depth,o=n.depth;for(;l&&o&&i.childCount==1;)i=i.firstChild.content,l--,o--;let a=new f.Slice(i,l,o);return e>-1?new b(r.pos,e,this.$to.pos,this.$to.end(),a,t):a.size||r.pos!=this.$to.pos?new S(r.pos,n.pos,a):null}findFittable(){let e=this.unplaced.openStart;for(let t=this.unplaced.content,r=0,n=this.unplaced.openEnd;r<e;r++){let i=t.firstChild;if(t.childCount>1&&(n=0),i.type.spec.isolating&&n<=r){e=r;break}t=i.content}for(let t=1;t<=2;t++)for(let r=t==1?e:this.unplaced.openStart;r>=0;r--){let n,i=null;r?(i=W(this.unplaced.content,r-1).firstChild,n=i.content):n=this.unplaced.content;let l=n.firstChild;for(let o=this.depth;o>=0;o--){let{type:a,match:h}=this.frontier[o],p,d=null;if(t==1&&(l?h.matchType(l.type)||(d=h.fillBefore(f.Fragment.from(l),!1)):i&&a.compatibleContent(i.type)))return{sliceDepth:r,frontierDepth:o,parent:i,inject:d};if(t==2&&l&&(p=h.findWrapping(l.type)))return{sliceDepth:r,frontierDepth:o,parent:i,wrap:p};if(i&&h.matchType(i.type))break}}}openMore(){let{content:e,openStart:t,openEnd:r}=this.unplaced,n=W(e,t);return!n.childCount||n.firstChild.isLeaf?!1:(this.unplaced=new f.Slice(e,t+1,Math.max(r,n.size+t>=e.size-r?t+1:0)),!0)}dropNode(){let{content:e,openStart:t,openEnd:r}=this.unplaced,n=W(e,t);if(n.childCount<=1&&t>0){let i=e.size-t<=t+n.size;this.unplaced=new f.Slice(O(e,t-1,1),t-1,i?t-1:r)}else this.unplaced=new f.Slice(O(e,t,1),t,r)}placeNodes({sliceDepth:e,frontierDepth:t,parent:r,inject:n,wrap:i}){for(;this.depth>t;)this.closeFrontierNode();if(i)for(let g=0;g<i.length;g++)this.openFrontierNode(i[g]);let l=this.unplaced,o=r?r.content:l.content,a=l.openStart-e,h=0,p=[],{match:d,type:c}=this.frontier[t];if(n){for(let g=0;g<n.childCount;g++)p.push(n.child(g));d=d.matchFragment(n)}let u=o.size+e-(l.content.size-l.openEnd);for(;h<o.childCount;){let g=o.child(h),v=d.matchType(g.type);if(!v)break;h++,(h>1||a==0||g.content.size)&&(d=v,p.push(re(g.mark(c.allowedMarks(g.marks)),h==1?a:0,h==o.childCount?u:-1)))}let m=h==o.childCount;m||(u=-1),this.placed=z(this.placed,t,f.Fragment.from(p)),this.frontier[t].match=d,m&&u<0&&r&&r.type==this.frontier[this.depth].type&&this.frontier.length>1&&this.closeFrontierNode();for(let g=0,v=o;g<u;g++){let F=v.lastChild;this.frontier.push({type:F.type,match:F.contentMatchAt(F.childCount)}),v=F.content}this.unplaced=m?e==0?f.Slice.empty:new f.Slice(O(l.content,e-1,1),e-1,u<0?l.openEnd:e-1):new f.Slice(O(l.content,e,h),l.openStart,l.openEnd)}mustMoveInline(){if(!this.$to.parent.isTextblock)return-1;let e=this.frontier[this.depth],t;if(!e.type.isTextblock||!D(this.$to,this.$to.depth,e.type,e.match,!1)||this.$to.depth==this.depth&&(t=this.findCloseLevel(this.$to))&&t.depth==this.depth)return-1;let{depth:r}=this.$to,n=this.$to.after(r);for(;r>1&&n==this.$to.end(--r);)++n;return n}findCloseLevel(e){e:for(let t=Math.min(this.depth,e.depth);t>=0;t--){let{match:r,type:n}=this.frontier[t],i=t<e.depth&&e.end(t+1)==e.pos+(e.depth-(t+1)),l=D(e,t,n,r,i);if(l){for(let o=t-1;o>=0;o--){let{match:a,type:h}=this.frontier[o],p=D(e,o,h,a,!0);if(!p||p.childCount)continue e}return{depth:t,fit:l,move:i?e.doc.resolve(e.after(t+1)):e}}}}close(e){let t=this.findCloseLevel(e);if(!t)return null;for(;this.depth>t.depth;)this.closeFrontierNode();t.fit.childCount&&(this.placed=z(this.placed,t.depth,t.fit)),e=t.move;for(let r=t.depth+1;r<=e.depth;r++){let n=e.node(r),i=n.type.contentMatch.fillBefore(n.content,!0,e.index(r));this.openFrontierNode(n.type,n.attrs,i)}return e}openFrontierNode(e,t=null,r){let n=this.frontier[this.depth];n.match=n.match.matchType(e),this.placed=z(this.placed,this.depth,f.Fragment.from(e.create(t,r))),this.frontier.push({type:e,match:e.contentMatch})}closeFrontierNode(){let t=this.frontier.pop().match.fillBefore(f.Fragment.empty,!0);t.childCount&&(this.placed=z(this.placed,this.frontier.length,t))}}function O(s,e,t){return e==0?s.cutByIndex(t,s.childCount):s.replaceChild(0,s.firstChild.copy(O(s.firstChild.content,e-1,t)))}function z(s,e,t){return e==0?s.append(t):s.replaceChild(s.childCount-1,s.lastChild.copy(z(s.lastChild.content,e-1,t)))}function W(s,e){for(let t=0;t<e;t++)s=s.firstChild.content;return s}function re(s,e,t){if(e<=0)return s;let r=s.content;return e>1&&(r=r.replaceChild(0,re(r.firstChild,e-1,r.childCount==1?t-1:0))),e>0&&(r=s.type.contentMatch.fillBefore(r).append(r),t<=0&&(r=r.append(s.type.contentMatch.matchFragment(r).fillBefore(f.Fragment.empty,!0)))),s.copy(r)}function D(s,e,t,r,n){let i=s.node(e),l=n?s.indexAfter(e):s.index(e);if(l==i.childCount&&!t.compatibleContent(i.type))return null;let o=r.fillBefore(i.content,!0,l);return o&&!Re(t,i.content,l)?o:null}function Re(s,e,t){for(let r=t;r<e.childCount;r++)if(!s.allowsMarks(e.child(r).marks))return!0;return!1}function Ee(s){return s.spec.defining||s.spec.definingForContent}function Te(s,e,t,r){if(!r.size)return s.deleteRange(e,t);let n=s.doc.resolve(e),i=s.doc.resolve(t);if(te(n,i,r))return s.step(new S(e,t,r));let l=ie(n,s.doc.resolve(t));l[l.length-1]==0&&l.pop();let o=-(n.depth+1);l.unshift(o);for(let c=n.depth,u=n.pos-1;c>0;c--,u--){let m=n.node(c).type.spec;if(m.defining||m.definingAsContext||m.isolating)break;l.indexOf(c)>-1?o=c:n.before(c)==u&&l.splice(1,0,-c)}let a=l.indexOf(o),h=[],p=r.openStart;for(let c=r.content,u=0;;u++){let m=c.firstChild;if(h.push(m),u==r.openStart)break;c=m.content}for(let c=p-1;c>=0;c--){let u=h[c],m=Ee(u.type);if(m&&!u.sameMarkup(n.node(Math.abs(o)-1)))p=c;else if(m||!u.type.isTextblock)break}for(let c=r.openStart;c>=0;c--){let u=(c+p+1)%(r.openStart+1),m=h[u];if(m)for(let g=0;g<l.length;g++){let v=l[(g+a)%l.length],F=!0;v<0&&(F=!1,v=-v);let se=n.node(v-1),P=n.index(v-1);if(se.canReplaceWith(P,P,m.type,m.marks))return s.replace(n.before(v),F?i.after(v):t,new f.Slice(ne(r.content,0,r.openStart,u),u,r.openEnd))}}let d=s.steps.length;for(let c=l.length-1;c>=0&&(s.replace(e,t,r),!(s.steps.length>d));c--){let u=l[c];u<0||(e=n.before(u),t=i.after(u))}}function ne(s,e,t,r,n){if(e<t){let i=s.firstChild;s=s.replaceChild(0,i.copy(ne(i.content,e+1,t,r,i)))}if(e>r){let i=n.contentMatchAt(0),l=i.fillBefore(s).append(s);s=l.append(i.matchFragment(l).fillBefore(f.Fragment.empty,!0))}return s}function Oe(s,e,t,r){if(!r.isInline&&e==t&&s.doc.resolve(e).parent.content.size){let n=_(s.doc,e,r.type);n!=null&&(e=t=n)}s.replaceRange(e,t,new f.Slice(f.Fragment.from(r),0,0))}function ze(s,e,t){let r=s.doc.resolve(e),n=s.doc.resolve(t),i=ie(r,n);for(let l=0;l<i.length;l++){let o=i[l],a=l==i.length-1;if(a&&o==0||r.node(o).type.contentMatch.validEnd)return s.delete(r.start(o),n.end(o));if(o>0&&(a||r.node(o-1).canReplace(r.index(o-1),n.indexAfter(o-1))))return s.delete(r.before(o),n.after(o))}for(let l=1;l<=r.depth&&l<=n.depth;l++)if(e-r.start(l)==r.depth-l&&t>r.end(l)&&n.end(l)-t!=n.depth-l&&r.start(l-1)==n.start(l-1)&&r.node(l-1).canReplace(r.index(l-1),n.index(l-1)))return s.delete(r.before(l),t);s.delete(e,t)}function ie(s,e){let t=[],r=Math.min(s.depth,e.depth);for(let n=r;n>=0;n--){let i=s.start(n);if(i<s.pos-(s.depth-n)||e.end(n)>e.pos+(e.depth-n)||s.node(n).type.spec.isolating||e.node(n).type.spec.isolating)break;(i==e.start(n)||n==s.depth&&n==e.depth&&s.parent.inlineContent&&e.parent.inlineContent&&n&&e.start(n-1)==i-1)&&t.push(n)}return t}class N extends y{constructor(e,t,r){super(),this.pos=e,this.attr=t,this.value=r}apply(e){let t=e.nodeAt(this.pos);if(!t)return w.fail("No node at attribute step's position");let r=Object.create(null);for(let i in t.attrs)r[i]=t.attrs[i];r[this.attr]=this.value;let n=t.type.create(r,null,t.marks);return w.fromReplace(e,this.pos,this.pos+1,new f.Slice(f.Fragment.from(n),0,t.isLeaf?0:1))}getMap(){return k.empty}invert(e){return new N(this.pos,this.attr,e.nodeAt(this.pos).attrs[this.attr])}map(e){let t=e.mapResult(this.pos,1);return t.deletedAfter?null:new N(t.pos,this.attr,this.value)}toJSON(){return{stepType:"attr",pos:this.pos,attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.pos!="number"||typeof t.attr!="string")throw new RangeError("Invalid input for AttrStep.fromJSON");return new N(t.pos,t.attr,t.value)}}y.jsonID("attr",N);class T extends y{constructor(e,t){super(),this.attr=e,this.value=t}apply(e){let t=Object.create(null);for(let n in e.attrs)t[n]=e.attrs[n];t[this.attr]=this.value;let r=e.type.create(t,e.content,e.marks);return w.ok(r)}getMap(){return k.empty}invert(e){return new T(this.attr,e.attrs[this.attr])}map(e){return this}toJSON(){return{stepType:"docAttr",attr:this.attr,value:this.value}}static fromJSON(e,t){if(typeof t.attr!="string")throw new RangeError("Invalid input for DocAttrStep.fromJSON");return new T(t.attr,t.value)}}y.jsonID("docAttr",T);let R=class extends Error{};R=function s(e){let t=Error.call(this,e);return t.__proto__=s.prototype,t};R.prototype=Object.create(Error.prototype);R.prototype.constructor=R;R.prototype.name="TransformError";class Je{constructor(e){this.doc=e,this.steps=[],this.docs=[],this.mapping=new E}get before(){return this.docs.length?this.docs[0]:this.doc}step(e){let t=this.maybeStep(e);if(t.failed)throw new R(t.failed);return this}maybeStep(e){let t=e.apply(this.doc);return t.failed||this.addStep(e,t.doc),t}get docChanged(){return this.steps.length>0}addStep(e,t){this.docs.push(this.doc),this.steps.push(e),this.mapping.appendMap(e.getMap()),this.doc=t}replace(e,t=e,r=f.Slice.empty){let n=ee(this.doc,e,t,r);return n&&this.step(n),this}replaceWith(e,t,r){return this.replace(e,t,new f.Slice(f.Fragment.from(r),0,0))}delete(e,t){return this.replace(e,t,f.Slice.empty)}insert(e,t){return this.replaceWith(e,e,t)}replaceRange(e,t,r){return Te(this,e,t,r),this}replaceRangeWith(e,t,r){return Oe(this,e,t,r),this}deleteRange(e,t){return ze(this,e,t),this}lift(e,t){return de(this,e,t),this}join(e,t=1){return Fe(this,e,t),this}wrap(e,t){return we(this,e,t),this}setBlockType(e,t=e,r,n=null){return ye(this,e,t,r,n),this}setNodeMarkup(e,t,r=null,n){return ke(this,e,t,r,n),this}setNodeAttribute(e,t,r){return this.step(new N(e,t,r)),this}setDocAttribute(e,t){return this.step(new T(e,t)),this}addNodeMark(e,t){return this.step(new C(e,t)),this}removeNodeMark(e,t){if(!(t instanceof f.Mark)){let r=this.doc.nodeAt(e);if(!r)throw new RangeError("No node at position "+e);if(t=t.isInSet(r.marks),!t)return this}return this.step(new I(e,t)),this}split(e,t=1,r){return xe(this,e,t,r),this}addMark(e,t,r){return he(this,e,t,r),this}removeMark(e,t,r){return pe(this,e,t,r),this}clearIncompatible(e,t,r){return q(this,e,t,r),this}}const Ae=Object.freeze(Object.defineProperty({__proto__:null,AddMarkStep:M,AddNodeMarkStep:C,AttrStep:N,DocAttrStep:T,MapResult:A,Mapping:E,RemoveMarkStep:x,RemoveNodeMarkStep:I,ReplaceAroundStep:b,ReplaceStep:S,Step:y,StepMap:k,StepResult:w,Transform:Je,get TransformError(){return R},canJoin:be,canSplit:ve,dropPoint:Ne,findWrapping:ue,insertPoint:_,joinPoint:Ce,liftTarget:ce,replaceStep:ee},Symbol.toStringTag,{value:"Module"})),De=le(Ae);export{E as M,b as R,k as S,be as a,De as b,ve as c,ue as f,ce as l,ee as r};
